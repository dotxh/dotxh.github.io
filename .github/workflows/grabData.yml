name: Update GitHub Pages Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch secret data with HMAC
        run: |
          TS=$(date -u +%s)
          NONCE=$(uuidgen)
          METHOD="GET"
          PATH="/data"
          HMAC_SECRET="${{ secrets.SIGNATURE }}"
          SECRET_URL="${{ secrets.SECRET_URL }}"
          PAYLOAD="${METHOD}${PATH}${TS}${NONCE}"
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -mac HMAC -macopt hexkey:"$HMAC_SECRET" | awk '{print $2}')
          DATA=$(curl -s -H "x-timestamp: $TS" -H "x-nonce: $NONCE" -H "x-signature: $SIGNATURE" "$SECRET_URL")
          echo '{}' | jq --arg ts "$TS" --arg nonce "$NONCE" --arg data "$DATA" '.timestamp=$ts | .nonce=$nonce | .data=$data' > data.json

      - name: Commit updated data.json
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "actions@github.com"
          git add data.json
          git diff --quiet || git commit -m "Update secret data with timestamp and nonce"
          git push
